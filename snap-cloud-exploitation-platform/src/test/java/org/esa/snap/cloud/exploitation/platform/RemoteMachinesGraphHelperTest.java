package org.esa.snap.cloud.exploitation.platform;

import org.esa.snap.core.gpf.graph.GraphException;
import org.esa.snap.engine_utilities.util.FileIOUtils;
import org.junit.Test;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertNull;
import static org.junit.Assert.fail;

/**
 * Created by jcoravu on 15/3/2019.
 */
public class RemoteMachinesGraphHelperTest extends AbstractTest {

    public RemoteMachinesGraphHelperTest() {
    }

    @Test
    public void testData() throws IOException, GraphException {
        Path localOutputFolder = this.cloudExploitationPlatformTestsFolderPath.resolve("output");
        try {
            if (!Files.exists(localOutputFolder)) {
                Files.createDirectory(localOutputFolder);
            }

            ILocalMachineFileSystem localMachineFileSystem = new WindowsLocalMachineFileSystem();

            Path slaveGraphFile = this.cloudExploitationPlatformTestsFolderPath.resolve("slave-graph.xml");
            if (!Files.exists(slaveGraphFile)) {
                fail("The slave graph file "+ slaveGraphFile.toString()+" does not exist.");
            }

            String[] relativeSourceProductFilePaths = new String[] { "3_8bit_components_srgb.tif", "S2AGRI_L3A_PVI_V20160930.jpg" };

            RemoteMachinesGraphHelper remoteMachinesGraphHelper = new RemoteMachinesGraphHelper(localMachineFileSystem, localOutputFolder, relativeSourceProductFilePaths, slaveGraphFile, false);

            RemoteMachineCredentials remoteMachine = new RemoteMachineCredentials();
            remoteMachine.setHostName("127.0.0.1");
            remoteMachine.setPortNumber(123);
            remoteMachine.setUsername("username");
            remoteMachine.setPassword("password");
            remoteMachine.setOperatingSystemName("Linux");
            remoteMachine.setSharedFolderPath("/home/username/remote-shared");
            remoteMachine.setGPTFilePath(null);

            IRemoteMachineFileSystem remoteMachineFileSystem = new IRemoteMachineFileSystem() {
                @Override
                public String normalizeFileSeparator(String path) {
                    return path.replace('\\', '/');
                }

                @Override
                public char getFileSeparatorChar() {
                    return '/';
                }
            };

            // create the slave graph for the first source product
            RemoteMachineMetadata result = remoteMachinesGraphHelper.computeNextGraphToRun(remoteMachine, remoteMachineFileSystem);
            assertNotNull(result);

            assertEquals("output/1/slave-graph.xml", result.getGraphRelativeFilePath());
            Path remoteMachineSlaveGraphFile = this.cloudExploitationPlatformTestsFolderPath.resolve(result.getGraphRelativeFilePath());
            if (!Files.exists(remoteMachineSlaveGraphFile)) {
                fail("The remote machine slave graph file "+ remoteMachineSlaveGraphFile.toString()+" does not exist.");
            }

            assertEquals("output/1/remote-product.dim", result.getOutputProductRelativeFilePath());

            String[] graphRelativeSourceProductFilePaths = result.getGraphRelativeSourceProductFilePaths();
            assertNotNull(graphRelativeSourceProductFilePaths);
            assertEquals(1, graphRelativeSourceProductFilePaths.length);
            assertEquals("3_8bit_components_srgb.tif", graphRelativeSourceProductFilePaths[0]);

            // consider that the source product is unprocessed
            remoteMachinesGraphHelper.revalidateUnprocessedGraphSourceProducts(remoteMachine, result);

            // create the slave graph for the second source product
            result = remoteMachinesGraphHelper.computeNextGraphToRun(remoteMachine, remoteMachineFileSystem);
            assertNotNull(result);

            assertEquals("output/2/slave-graph.xml", result.getGraphRelativeFilePath());
            remoteMachineSlaveGraphFile = this.cloudExploitationPlatformTestsFolderPath.resolve(result.getGraphRelativeFilePath());
            if (!Files.exists(remoteMachineSlaveGraphFile)) {
                fail("The remote machine slave graph file "+ remoteMachineSlaveGraphFile.toString()+" does not exist.");
            }

            assertEquals("output/2/remote-product.dim", result.getOutputProductRelativeFilePath());

            graphRelativeSourceProductFilePaths = result.getGraphRelativeSourceProductFilePaths();
            assertNotNull(graphRelativeSourceProductFilePaths);
            assertEquals(1, graphRelativeSourceProductFilePaths.length);
            assertEquals("S2AGRI_L3A_PVI_V20160930.jpg", graphRelativeSourceProductFilePaths[0]);

            // consider that the source product is unprocessed
            remoteMachinesGraphHelper.revalidateUnprocessedGraphSourceProducts(remoteMachine, result);

            boolean canContinue = remoteMachinesGraphHelper.canContinueIfExceptionOccurredOnRemoteMachines();
            assertEquals(true, canContinue);

            // no graph can be processed by the same remote machine
            result = remoteMachinesGraphHelper.computeNextGraphToRun(remoteMachine, remoteMachineFileSystem);
            assertNull(result);

            remoteMachinesGraphHelper.setExceptionOccurredOnRemoteMachine(new Exception());
            canContinue = remoteMachinesGraphHelper.canContinueIfExceptionOccurredOnRemoteMachines();
            assertEquals(false, canContinue);

            String[] outputProductsRelativeFilePath = remoteMachinesGraphHelper.getOutputProductsRelativeFilePath();
            assertNotNull(outputProductsRelativeFilePath);
            assertEquals(0, outputProductsRelativeFilePath.length);
        } finally {
            FileIOUtils.deleteFolder(localOutputFolder);
        }
    }
}
